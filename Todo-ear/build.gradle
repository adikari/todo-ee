apply plugin: "ear"

description = "Todo-ear"

def dbhome = "/Users/subash/.netbeans-derby"
def domain = "domain1"
def asadminBin = "/Applications/NetBeans/glassfish-4.1.1/glassfish/bin"

dependencies {
  deploy project(":Todo-ejb")
  deploy project(path: ":Todo-web", configuration: "archives")

  add ("earlib", project(":Todo-ri")) {
    transitive = false
  }
}

task run(dependsOn: "ear", type: Exec) {
  group = 'Build'
  description = 'Build ear and deploy to glassfish server'

  commandLine "asadmin"

  args "deploy", "--force=true", "${ear.archivePath}"

  standardOutput = new ByteArrayOutputStream()

  ext.output = {
    return standardOutput.toString()
  }
}

task startServer(dependsOn: "startDb", type: Exec) {
  group = 'Build Setup'
  description = 'Start glassfish server'

  ignoreExitValue true

  commandLine "${asadminBin}/asadmin"
  args "start-domain", "--debug", "${domain}"

  standardOutput = new ByteArrayOutputStream()

  ext.output = {
    return standardOutput.toString()
  }

  doLast {
    if(execResult.exitValue == 1) {
      logger.warn(startServer.output())
    }
  }
}

task startDb(type: Exec) {
  group = 'Build Setup'
  description = 'Start derby database'

  commandLine "asadmin"

  args "start-database", "--dbhome", dbhome

  standardOutput = new ByteArrayOutputStream()

  ext.output = {
    return standardOutput.toString()
  }
}


